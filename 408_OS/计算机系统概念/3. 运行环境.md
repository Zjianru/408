# 处理器运行模式
在计算机系统中，通常 CPU 执行两种不同性质的程序：
1. 操作系统内核程序
2. 用户自编程序（即系统外层的应用程序，或简称“应用程序”）

对操作系统而言，这两种程序的作用不同，前者是后者的管理者，因此内核程序要执行一些特权指令，而用户自编程序出于安全考虑不能执行这些指令

1. 特权指令，是指不允许用户直接使用的指令，如VO 指令、置中断指令，存取用于内存保护的寄存器、送程序状态字到程序状态字寄存器等的指令
2. 非特权指令，是指允许用户直接使用的指令，它不能直接访问系统中的软硬件资源，仅限于访问用户的地址空间，这也是为了防止用户程序对系统造成破坏

在具体实现上，**将 CPU 的运行模式划分为用户态（目态）和核心态（又称管态、内核态)**。

应用程序运行在用户态，操作系统内核程序运行在核心态。

应用程序向操作系统请求服务时 **使用访管指令**，从而产生一个**中断事件将操作系统转换为核心态**。

在软件工程思想和结构化程序设计方法影响下诞生的现代操作系统，几乎都是**分层式的结构**。操作系统的各项功能分别被设置在不同的层次上。

一些**与硬件关联较紧密的模块**，如**时钟管理、中断处理、设备驱动**等处于最低层。
其次是**运行频率较高的程序**，如**进程管理、存储器管理和设备管理**等。
这两部分内容构成了操作系统的内核。指令操作工作在核心态。

内核是计算机上配置的底层软件，它管理着系统的各种资源，可以看作是连接应用程序和硬件的一座桥梁，大多数操作系统的内核包括4方面的内容。

## 时钟管理

在计算机的各种部件中，**时钟是最关键的设备**

两个基本功能：

**计时**，**操作系统需要通过时钟管理，向用户提供标准的系统时间**

**通过时钟中断的管理，可以实现进程的切换**


## 中断机制

初衷是**提高多道程序运行环境中 CPU 的利用率**

现代操作系统是靠中断驱动的软件

中断机制中，只有一小部分功能属于内核，它们负责保护和恢复中断现场的信息，转移控制权到相关的处理程序
这样可以减少中断的处理时间，提高系统的并行处理能力

## 原语
按层次结构设计的操作系统，底层必然是一些可被调用的公用小程序，它们各自完成一个规定的操作

特点
1. 处于操作系统的最底层，是最接近硬件的部分
2. 这些程序的运行具有原子性，其操作只能一气呵成（出于系统安全性和便于管理考虑)
3. 这些程序的运行时间都较短，而且调用频繁

具有这些特点的程序称为原语 `Atomic Operation`
定义原语的直接方法是关闭中断，让其所有动作不可分割地完成后再打开中断
系统中的设备驱动、CPU 切换、进程通信等功能中的部分操作都可定义为原语，使它们成为内核的组成部分

## 系统控制的数据结构及处理

系统中用来登记状态信息的数据结构很多，为了实现有效的管理，需要一些基本的操作，常见有 3 种

1. 进程管理。进程状态管理、进程调度和分派、创建与撤销进程控制块等
2. 存储器管理。存储器的空间分配和回收、内存信息保护程序、代码对换程序等
3. 设备管理。缓冲区管理、设备分配和回收等

核心态指令实际上包括系统调用类指令和一些针对时钟、中断和原语的操作指令

# 中断和异常的概念
在操作系统中引入核心态和用户态这两种工作状态后，就需要考虑这两种状态之间如何切换。

在实际操作系统中，发生中断或异常时，运行用户态的 CPU 会立即进入核心态，这是通过硬件实现的

操作系统的发展过程是不断提高资源利用率的过程，提高资源利用率就要在程序并未使用某种资源时，把对资源的占有权释放，这一行为需要通过中断
## 中断和异常的定义

中断 `Interruption` 
	也称外中断，是指来自 CPU 执行指令外部的事件，通常用于信息输入/输出，如设备发出的T/O 结束中断，表示设备输入/输出处理己经完成
	时钟中断，表示一个固定的时间片已到，让处理机处理计时、启动定时运行的任务等

异常 `Exception` 
	也称内中断，是指来自 CPU 执行指令内部的事件，如程序的非法操作码、地址越界、运故障(Fault)算溢出、虚存系统的缺页及专门的陷入指令等引起的事件
	异常不能被屏蔽，一旦出现，就应立即处理
	![[内中断和外中断的联系与区别.png]]
## 中断和异常的分类

外中断可分为**可屏蔽中断**和**不可屏蔽中断**

可屏蔽中断是指通过 INTR 线发出的中断请求，通过改变屏蔽字可实现多重中断，从而使得中断处理更加灵活

不可屏蔽中断是指通过 NMI 线发出的中断请求，通常是紧急的硬件故障，如电源掉电等

异常也是不能被屏蔽的

异常可分为**故障**、**自陷**和**终止**

故障 `Fault` 
	通常是由指令执行引起的异常，如非法操作码、缺页故障、除数为 0、运算溢出等
	
自陷 `Trap` 
	一种事先安排的异常事件，用于在用户态下调用操作系统内核程序，如条件陷阱指令
	
终止 `Abort` 
	指出现了使得 CPU 无法继续执行的硬件故障，如控制器出错、存储器校验错等

**故障异常属于软件中断（程序性异常)，终止异常和外部中断属于硬件中断**


## 系统调用

系统调用，指用户在程序中调用操作系统所提供的一些子功能，可视为特殊的公共子程序

在用户程序中，与资源有关的操作（如存储分配、进行 I/O 传输及管理文件等)，都必须通过系统调用方式向操作系统提出服务请求，并由操作系统代为完成

系统调用按功能可分为
- 设备管理。完成设备的请求或释放，以及设备启动等功能
- 文件管理。完成文件的读、写、创建及删除等功能
- 进程控制。完成进程的创建、撤销、阻塞及唤醒等功能
- 进程通信。完成进程之间的消息传递或信号传递等功能
- 内存管理。完成内存的分配、回收以及获取作业占用内存区大小及始址等功能

系统调用相关功能对整个系统的影响非常大，需要使用特权指令才能完成，所以系统调用的处理需要由操作系统内核程序负责完成，要运行在核心态

**用户程序可以执行陷入指令（又称访管指令或 trap 指令）来发起系统调用，请求操作系统提供服务**

用户程序执行陷入指令，相当于把 CPU 的使用权主动交给操作系统内核程序（CPU 状态会从用户态进入核心态)，之后操作系统内核程序再对系统调用请求做出相应处理。处理完成后，操作系统内核程序又会把 CPU 的使用权还给用户程序（CPU 状态会从核心态回到用户态)

这么设计的目的是：用户程序不能直接执行对系统影响非常大的操作，必须通过系统调用的方式请求操作系统代为执行，以便保证系统的稳定性和安全性，防止用户程序随意更改或访问重要的系统资源，影响其他进程的运行

操作系统的运行环境就可以理解为：用户通过操作系统运行上层程序（如系统提供的命令解释程序或用户自编程序)，而这个上层程序的运行依赖于操作系统的底层管理程序提供服务支持，**当需要管理程序服务时，系统则通过硬件中断机制进入核心态**，运行管理程序，也可能是程序运行出现异常情况，**被动地需要管理程序的服务，这时就通过异常处理来进入核心态**。管理程序运行结束时，用户程序需要继续运行，此时通过相应的保存的程序现场退出中断处理程序或异常处理程序，返回断点处继续执行

![[系统调用执行过程.png]]
在操作系统这一层面上，关心的是核心态和用户态的软件实现与切换，对于硬件层面的具体理解，可以结合计算机组成原理中有关中断的内容进行学习

列举一些由用户态转向核心态的例子
1. 用户程序要求操作系统的服务，即系统调用
2. 发生一次中断
3. 用户程序中产生了一个错误状态
4. 用户程序中企图执行一条特权指令
5. 从核心态转向用户态由一条指令实现，这条指令也是特权命令，一般是中断返回指令

**由用户态进入核心态，不仅状态需要切换，所用的堆栈也可能需要由用户堆栈切换为系统堆栈，但这个系统堆栈也是属于该进程的**

若程序的运行由用户态转到核心态，则会用到访管指令，访管指令是在用户态使用的，所以不是特权指令

访问管态的指令 - 【访管指令】




